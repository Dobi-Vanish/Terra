<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .map-container {
            position: relative;
            width: 100%;
            height: 80vh;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }

        #svgContainer {
            width: 100%;
            height: 100%;
            cursor: grab;
            transform-origin: 0 0;
            transition: transform 0.1s ease;
        }

        #svgContainer:active {
            cursor: grabbing;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .marker {
            position: absolute;
            cursor: pointer;
            transform: translate(-50%, -50%);
            z-index: 100;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 101;
        }

        .marker:hover::after {
            content: attr(data-title);
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }

        .drawing-path {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 50;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .zoom-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }

        .active-tool {
            background-color: #007bff !important;
            color: white !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è SVG —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .svg-country:hover {
            stroke: #007bff;
            stroke-width: 2;
            cursor: pointer;
        }

        .svg-city {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .svg-city:hover {
            fill: #007bff !important;
            transform: scale(1.2);
        }

        .icon-preview {
            font-size: 24px;
            margin-right: 10px;
        }

        .marker-size-control {
            width: 100%;
        }

        .icon-emoji {
            font-size: 20px;
            display: block;
            text-align: center;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="index.html">RPG –ú–∏—Ä</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="races.html">–†–∞—Å—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="classes.html">–ö–ª–∞—Å—Å—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="religions.html">–†–µ–ª–∏–≥–∏–∏</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="applications.html">–ê–Ω–∫–µ—Ç—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="mechanics.html">–ú–µ—Ö–∞–Ω–∏–∫–∏</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="abilities.html">–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="sheet.html">–õ–∏—Å—Ç –∏–≥—Ä–æ–∫–∞</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="multirace.html">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É–∫—Ä–æ–≤–æ–∫</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="diceroller.html">Dice roller</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="map.html">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <div class="jumbotron bg-primary text-white p-4 mb-4 border-radius-lg">
                <h1 class="display-4">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</h1>
                <p class="lead">–ò—Å—Å–ª–µ–¥—É–π—Ç–µ –º–∏—Ä, —Å—Ç–∞–≤—å—Ç–µ –º–µ—Ç–∫–∏ –∏ —Ä–∏—Å—É–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã</p>
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active-tool" id="panTool">
                            üñ±Ô∏è –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                        </button>
                        <button type="button" class="btn btn-outline-success" id="markerTool">
                            üìç –ú–µ—Ç–∫–∏
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="clearAll">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="currentTool">–¢–µ–∫—É—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="map-container">
                        <!-- SVG –∫–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                        <div id="svgContainer"></div>

                        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="map-controls">
                            <div class="btn-group-vertical">
                                <button class="btn btn-light tool-btn" id="zoomIn" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å">
                                    +
                                </button>
                                <button class="btn btn-light tool-btn" id="zoomOut" title="–û—Ç–¥–∞–ª–∏—Ç—å">
                                    -
                                </button>
                                <button class="btn btn-light tool-btn" id="resetView" title="–°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥">
                                    ‚Ü∫
                                </button>
                            </div>
                        </div>

                        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑—É–º–∞ -->
                        <div class="zoom-display">
                            –ú–∞—Å—à—Ç–∞–±: <span id="zoomLevel">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –º–µ—Ç–æ–∫ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">–ú–æ–∏ –º–µ—Ç–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div id="markersList">
                        <p class="text-muted">–ú–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –§—É—Ç–µ—Ä -->
<footer class="bg-dark text-white py-3 mt-4">
    <div class="container text-center">
        <p class="mb-0">–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞ &copy; 2023</p>
    </div>
</footer>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ç–∫–∏ -->
<div class="modal fade" id="markerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –º–µ—Ç–∫—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="markerTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏</label>
                            <input type="text" class="form-control" id="markerTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                        </div>
                        <div class="mb-3">
                            <label for="markerDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="markerDescription" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="markerColor" class="form-label">–¶–≤–µ—Ç –º–µ—Ç–∫–∏</label>
                            <input type="color" class="form-control" id="markerColor" value="#dc3545">
                        </div>
                        <div class="mb-3">
                            <label for="markerSize" class="form-label">–†–∞–∑–º–µ—Ä –º–µ—Ç–∫–∏: <span id="sizeValue">30</span>px</label>
                            <input type="range" class="form-range marker-size-control" id="markerSize" min="15" max="60" value="30">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">–¢–∏–ø –º–µ—Ç–∫–∏:</label>
                        <div class="row g-2" id="iconSelector">
                            <!-- –ò–∫–æ–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveMarker">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É</button>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–∫–æ–Ω–æ–∫ –¥–ª—è —Ñ—ç–Ω—Ç–µ–∑–∏ –∫–∞—Ä—Ç
    const fantasyIcons = [
        { emoji: 'üö©', name: '–ì—Ä—É–ø–ø–∞', color: '#F0E68C', description: '–ì—Ä—É–ø–ø–∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω—Ü–µ–≤' },
        { emoji: 'üè∞', name: '–ó–∞–º–æ–∫', color: '#8B4513', description: '–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –∑–∞–º–æ–∫ –∏–ª–∏ –∫—Ä–µ–ø–æ—Å—Ç—å' },
        { emoji: 'üèòÔ∏è', name: '–ì–æ—Ä–æ–¥', color: '#2E8B57', description: '–ö—Ä—É–ø–Ω—ã–π –≥–æ—Ä–æ–¥ –∏–ª–∏ —Å—Ç–æ–ª–∏—Ü–∞' },
        { emoji: 'üè†', name: '–î–µ—Ä–µ–≤–Ω—è', color: '#228B22', description: '–ù–µ–±–æ–ª—å—à–∞—è –¥–µ—Ä–µ–≤–Ω—è –∏–ª–∏ –ø–æ—Å–µ–ª–µ–Ω–∏–µ' },
        { emoji: '‚öîÔ∏è', name: '–ë–∏—Ç–≤–∞', color: '#DC143C', description: '–ú–µ—Å—Ç–æ —Å—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –±–∏—Ç–≤—ã' },
        { emoji: 'üèïÔ∏è', name: '–õ–∞–≥–µ—Ä—å', color: '#DAA520', description: '–í—Ä–µ–º–µ–Ω–Ω—ã–π –ª–∞–≥–µ—Ä—å –∏–ª–∏ —Å—Ç–æ—è–Ω–∫–∞' },
        { emoji: 'üèîÔ∏è', name: '–ì–æ—Ä—ã', color: '#696969', description: '–ì–æ—Ä–Ω—ã–π —Ö—Ä–µ–±–µ—Ç –∏–ª–∏ –≤–µ—Ä—à–∏–Ω–∞' },
        { emoji: 'üå≤', name: '–õ–µ—Å', color: '#006400', description: '–õ–µ—Å–Ω–∞—è —á–∞—â–∞ –∏–ª–∏ —Ä–æ—â–∞' },
        { emoji: 'üèûÔ∏è', name: '–†–µ–∫–∞', color: '#1E90FF', description: '–†–µ–∫–∞ –∏–ª–∏ –≤–æ–¥–Ω—ã–π –ø–æ—Ç–æ–∫' },
        { emoji: 'üåä', name: '–û–∑–µ—Ä–æ', color: '#4169E1', description: '–û–∑–µ—Ä–æ –∏–ª–∏ –≤–æ–¥–æ—ë–º' },
        { emoji: 'üè∫', name: '–†—É–∏–Ω—ã', color: '#8B7355', description: '–î—Ä–µ–≤–Ω–∏–µ —Ä—É–∏–Ω—ã –∏–ª–∏ —Ö—Ä–∞–º' },
        { emoji: 'üêâ', name: '–õ–æ–≥–æ–≤–æ', color: '#4B0082', description: '–õ–æ–≥–æ–≤–æ –¥—Ä–∞–∫–æ–Ω–∞ –∏–ª–∏ –º–æ–Ω—Å—Ç—Ä–∞' },
        { emoji: 'üí∞', name: '–°–æ–∫—Ä–æ–≤–∏—â–µ', color: '#FFD700', description: '–°–æ–∫—Ä–æ–≤–∏—â–µ –∏–ª–∏ –∫–ª–∞–¥' },
        { emoji: '‚öì', name: '–ü–æ—Ä—Ç', color: '#000080', description: '–ú–æ—Ä—Å–∫–æ–π –ø–æ—Ä—Ç –∏–ª–∏ –≥–∞–≤–∞–Ω—å' },
        { emoji: 'üõ°Ô∏è', name: '–§–æ—Ä—Ç', color: '#8B0000', description: '–í–æ–µ–Ω–Ω—ã–π —Ñ–æ—Ä—Ç –∏–ª–∏ –∑–∞—Å—Ç–∞–≤–∞' },
        { emoji: 'üìú', name: '–¢–∞–π–Ω–∞', color: '#2F4F4F', description: '–ó–∞–≥–∞–¥–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –∏–ª–∏ —Ç–∞–π–Ω–∞' },
        { emoji: 'üîÆ', name: '–ú–∞–≥–∏—è', color: '#8A2BE2', description: '–ú–∞–≥–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫' },
        { emoji: 'üíÄ', name: '–û–ø–∞—Å–Ω–æ—Å—Ç—å', color: '#800000', description: '–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ –∏–ª–∏ –ª–æ–≤—É—à–∫–∞' },
        { emoji: '‚≠ê', name: '–í–∞–∂–Ω–æ–µ', color: '#FF8C00', description: '–í–∞–∂–Ω–æ–µ –º–µ—Å—Ç–æ –∏–ª–∏ —Ü–µ–ª—å' },
        { emoji: 'üõí', name: '–¢–æ—Ä–≥–æ–≤–ª—è', color: '#FF69B4', description: '–†—ã–Ω–æ–∫ –∏–ª–∏ —Ç–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥—å' },
        { emoji: '‚õ™', name: '–•—Ä–∞–º', color: '#F0E68C', description: '–•—Ä–∞–º –∏–ª–∏ —Å–≤—è—â–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ' }
    ];

    class InteractiveMap {
        constructor() {
            this.container = document.querySelector('.map-container');
            this.svgContainer = document.getElementById('svgContainer');
            this.currentTool = 'pan';
            this.scale = 1;
            this.position = { x: 0, y: 0 };
            this.isDragging = false;
            this.dragStart = { x: 0, y: 0 };
            this.markers = [];
            this.paths = [];
            this.isDrawing = false;
            this.currentPath = null;
            this.svgElement = null;
            this.currentIcon = fantasyIcons[0];
            this.markerSize = 30;

            this.init();
        }

        async init() {
            await this.loadSVG();
            this.setupIconSelector();
            this.setupEventListeners();
            this.updateView();
        }

        setupIconSelector() {
            const container = document.getElementById('iconSelector');
            fantasyIcons.forEach((icon, index) => {
                const col = document.createElement('div');
                col.className = 'col-4 col-sm-3';
                col.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="iconType"
                                   id="icon${index}" value="${index}" ${index === 0 ? 'checked' : ''}>
                            <label class="form-check-label" for="icon${index}">
                                <span class="icon-emoji">${icon.emoji}</span>
                                <small class="d-block">${icon.name}</small>
                            </label>
                        </div>
                    `;
                container.appendChild(col);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏
            document.querySelectorAll('input[name="iconType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    this.currentIcon = fantasyIcons[parseInt(e.target.value)];
                    document.getElementById('markerColor').value = this.currentIcon.color;
                });
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞–∑–º–µ—Ä–∞ –º–µ—Ç–∫–∏
            document.getElementById('markerSize').addEventListener('input', (e) => {
                this.markerSize = parseInt(e.target.value);
                document.getElementById('sizeValue').textContent = this.markerSize;
            });
        }

        async loadSVG() {
            try {
                const response = await fetch('images/map.svg');
                const svgText = await response.text();

                this.svgContainer.innerHTML = svgText;
                this.svgElement = this.svgContainer.querySelector('svg');

                if (!this.svgElement) {
                    throw new Error('SVG –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ');
                }

                this.svgElement.style.width = '100%';
                this.svgElement.style.height = '100%';
                this.svgElement.style.cursor = 'grab';
                this.svgElement.style.transformOrigin = '0 0';
                this.svgElement.style.transition = 'transform 0.1s ease';

                this.addInteractivityToSVG();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ SVG:', error);
                this.svgContainer.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                            <div style="text-align: center;">
                                <h4>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</h4>
                                <p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª map.svg –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ images/</p>
                                <p>–û—à–∏–±–∫–∞: ${error.message}</p>
                            </div>
                        </div>
                    `;
            }
        }

        addInteractivityToSVG() {
            const allElements = this.svgElement.querySelectorAll('*');

            allElements.forEach(element => {
                if (element.tagName === 'path' || element.tagName === 'polygon') {
                    element.classList.add('svg-country');
                } else if (element.tagName === 'circle') {
                    element.classList.add('svg-city');
                }

                element.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (this.currentTool === 'select') {
                        this.handleSVGElementClick(element);
                    }
                });
            });
        }

        handleSVGElementClick(element) {
            const previousSelected = this.svgElement.querySelector('.selected');
            if (previousSelected) {
                previousSelected.classList.remove('selected');
            }

            element.classList.add('selected');

            const title = element.getAttribute('data-title') ||
                element.getAttribute('aria-label') ||
                element.id ||
                '–≠–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã';

            alert(`–í—ã–±—Ä–∞–Ω–æ: ${title}`);
        }

        setupEventListeners() {
            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
            document.getElementById('panTool').addEventListener('click', () => this.setTool('pan'));
            document.getElementById('markerTool').addEventListener('click', () => this.setTool('marker'));
            document.getElementById('drawTool').addEventListener('click', () => this.setTool('draw'));
            document.getElementById('selectTool').addEventListener('click', () => this.setTool('select'));
            document.getElementById('clearAll').addEventListener('click', () => this.clearAll());

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º
            document.getElementById('zoomIn').addEventListener('click', () => this.zoom(0.2));
            document.getElementById('zoomOut').addEventListener('click', () => this.zoom(-0.2));
            document.getElementById('resetView').addEventListener('click', () => this.resetView());

            // –°–æ–±—ã—Ç–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç—ã
            this.container.addEventListener('mousedown', this.handleMouseDown.bind(this));
            this.container.addEventListener('mousemove', this.handleMouseMove.bind(this));
            this.container.addEventListener('mouseup', this.handleMouseUp.bind(this));
            this.container.addEventListener('wheel', this.handleWheel.bind(this));

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
            this.container.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        setTool(tool) {
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active-tool');
            });
            document.getElementById(tool + 'Tool').classList.add('active-tool');

            this.currentTool = tool;
            const toolNames = {
                'pan': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
                'marker': '–ú–µ—Ç–∫–∏',
                'draw': '–†–∏—Å–æ–≤–∞–Ω–∏–µ',
                'select': '–í—ã–¥–µ–ª–µ–Ω–∏–µ'
            };
            document.getElementById('currentTool').textContent = `–¢–µ–∫—É—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${toolNames[tool]}`;

            if (this.svgElement) {
                this.svgElement.style.cursor = tool === 'pan' ? 'grab' :
                    tool === 'select' ? 'crosshair' : 'default';
            }

            if (tool !== 'draw' && this.isDrawing) {
                this.finishDrawing();
            }
        }

        handleMouseDown(e) {
            if (!this.svgElement) return;

            const rect = this.container.getBoundingClientRect();
            const x = (e.clientX - rect.left - this.position.x) / this.scale;
            const y = (e.clientY - rect.top - this.position.y) / this.scale;

            if (this.currentTool === 'pan') {
                this.isDragging = true;
                this.dragStart = { x: e.clientX - this.position.x, y: e.clientY - this.position.y };
                if (this.svgElement) this.svgElement.style.cursor = 'grabbing';
            }
            else if (this.currentTool === 'marker' && e.button === 0) {
                this.createMarker(x, y);
            }
            else if (this.currentTool === 'draw' && e.button === 0) {
                this.startDrawing(x, y);
            }
        }

        handleMouseMove(e) {
            if (this.isDragging && this.currentTool === 'pan') {
                this.position.x = e.clientX - this.dragStart.x;
                this.position.y = e.clientY - this.dragStart.y;
                this.updateView();
            }
            else if (this.isDrawing && this.currentTool === 'draw') {
                const rect = this.container.getBoundingClientRect();
                const x = (e.clientX - rect.left - this.position.x) / this.scale;
                const y = (e.clientY - rect.top - this.position.y) / this.scale;
                this.continueDrawing(x, y);
            }
        }

        handleMouseUp(e) {
            if (this.isDragging) {
                this.isDragging = false;
                if (this.svgElement) this.svgElement.style.cursor = 'grab';
            }
            else if (this.isDrawing && this.currentTool === 'draw') {
                this.finishDrawing();
            }
        }

        handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            this.zoom(delta, e.clientX, e.clientY);
        }

        zoom(delta, centerX = null, centerY = null) {
            const oldScale = this.scale;
            this.scale = Math.max(0.1, Math.min(5, this.scale + delta));

            if (centerX && centerY) {
                const rect = this.container.getBoundingClientRect();
                const mouseX = centerX - rect.left;
                const mouseY = centerY - rect.top;

                this.position.x = mouseX - (mouseX - this.position.x) * (this.scale / oldScale);
                this.position.y = mouseY - (mouseY - this.position.y) * (this.scale / oldScale);
            }

            this.updateView();
        }

        updateView() {
            if (this.svgElement) {
                this.svgElement.style.transform = `translate(${this.position.x}px, ${this.position.y}px) scale(${this.scale})`;
            }
            document.getElementById('zoomLevel').textContent = `${Math.round(this.scale * 100)}%`;

            this.markers.forEach(marker => {
                marker.element.style.left = `${marker.x * this.scale + this.position.x}px`;
                marker.element.style.top = `${marker.y * this.scale + this.position.y}px`;
            });

            this.paths.forEach(path => {
                path.element.style.transform = `translate(${this.position.x}px, ${this.position.y}px) scale(${this.scale})`;
            });
        }

        resetView() {
            this.scale = 1;
            this.position = { x: 0, y: 0 };
            this.updateView();
        }

        createMarker(x, y) {
            const modal = new bootstrap.Modal(document.getElementById('markerModal'));

            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            document.getElementById('markerTitle').value = '';
            document.getElementById('markerDescription').value = '';
            document.getElementById('markerSize').value = '30';
            document.getElementById('sizeValue').textContent = '30';

            modal.show();

            document.getElementById('saveMarker').onclick = () => {
                const title = document.getElementById('markerTitle').value || this.currentIcon.name;
                const description = document.getElementById('markerDescription').value || this.currentIcon.description;
                const color = document.getElementById('markerColor').value;
                const size = parseInt(document.getElementById('markerSize').value);

                this.addMarker(x, y, title, description, color, size, this.currentIcon.emoji);
                modal.hide();
            };
        }

        addMarker(x, y, title, description, color, size, emoji) {
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.width = `${size}px`;
            marker.style.height = `${size}px`;
            marker.style.fontSize = `${size * 0.7}px`;
            marker.style.color = this.getContrastColor(color);
            marker.style.backgroundColor = color;
            marker.style.borderRadius = '50%';
            marker.style.border = `2px solid ${this.getContrastColor(color)}`;
            marker.setAttribute('data-title', title);
            marker.textContent = emoji;

            marker.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É "${title}"?`)) {
                    const index = this.markers.findIndex(m => m.element === marker);
                    if (index > -1) {
                        this.removeMarker(index);
                    }
                }
            });

            this.container.appendChild(marker);

            const markerData = {
                element: marker,
                x: x,
                y: y,
                title: title,
                description: description,
                color: color,
                size: size,
                emoji: emoji,
                type: this.currentIcon.name
            };

            this.markers.push(markerData);
            this.updateView();
            this.updateMarkersList();
        }

        getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(1, 2), 16);
            const g = parseInt(hexcolor.substr(3, 2), 16);
            const b = parseInt(hexcolor.substr(5, 2), 16);
            const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return brightness > 128 ? '#000000' : '#FFFFFF';
        }

        startDrawing(x, y) {
            this.isDrawing = true;

            const pathSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            pathSvg.className = 'drawing-path';
            pathSvg.setAttribute('width', this.container.offsetWidth);
            pathSvg.setAttribute('height', this.container.offsetHeight);
            pathSvg.style.position = 'absolute';
            pathSvg.style.top = '0';
            pathSvg.style.left = '0';

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke', '#007bff');
            path.setAttribute('stroke-width', '3');
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke-linecap', 'round');
            path.setAttribute('stroke-linejoin', 'round');
            path.setAttribute('d', `M ${x} ${y}`);

            pathSvg.appendChild(path);
            this.container.appendChild(pathSvg);

            this.currentPath = {
                element: pathSvg,
                path: path,
                points: [{x, y}]
            };
        }

        continueDrawing(x, y) {
            if (!this.currentPath) return;

            this.currentPath.points.push({x, y});
            const d = this.currentPath.points.map((point, i) =>
                `${i === 0 ? 'M' : 'L'} ${point.x} ${point.y}`
            ).join(' ');

            this.currentPath.path.setAttribute('d', d);
        }

        finishDrawing() {
            this.isDrawing = false;
            if (this.currentPath && this.currentPath.points.length > 1) {
                this.paths.push(this.currentPath);
            }
            this.currentPath = null;
        }

        updateMarkersList() {
            const list = document.getElementById('markersList');

            if (this.markers.length === 0) {
                list.innerHTML = '<p class="text-muted">–ú–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }

            list.innerHTML = '';

            this.markers.forEach((marker, index) => {
                const item = document.createElement('div');
                item.className = 'd-flex justify-content-between align-items-center p-2 border-bottom';
                item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span style="font-size: 20px; margin-right: 10px;">${marker.emoji}</span>
                            <div>
                                <strong>${marker.title}</strong>
                                <br>
                                <small class="text-muted">${marker.type} ‚Ä¢ ${marker.size}px</small>
                                ${marker.description ? `<br><small class="text-muted">${marker.description}</small>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger delete-marker" data-index="${index}">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    `;
                list.appendChild(item);
            });

            document.querySelectorAll('.delete-marker').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    this.removeMarker(index);
                });
            });
        }

        removeMarker(index) {
            if (this.markers[index]) {
                this.markers[index].element.remove();
                this.markers.splice(index, 1);
                this.updateMarkersList();
            }
        }

        clearAll() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ –∏ —Ä–∏—Å—É–Ω–∫–∏?')) {
                this.markers.forEach(marker => marker.element.remove());
                this.markers = [];

                this.paths.forEach(path => path.element.remove());
                this.paths = [];

                if (this.svgElement) {
                    const selected = this.svgElement.querySelector('.selected');
                    if (selected) selected.classList.remove('selected');
                }

                this.updateMarkersList();
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
        new InteractiveMap();
    });
</script>
</body>
</html>